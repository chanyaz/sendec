{% extends 'index_new.html' %}
{% load staticfiles %}
{% block current_news %}
{% load my %}

    <script>
    // Refresh latest news
        function load_latest_news() {
            $.ajax({
                type: "POST",
                url: "/news/update_latest/",
                success: $.get("/news/update_latest/").done(function (data) {
                    //$(".latest-title-list").prepend(data.string[0]);
                    data.latest_news.forEach(function (cur_lat_news) {
                        if(cur_lat_news.shown == false) {
                            $(".latest-titles-list").prepend(data.string[0]);

                            $.get("/news/ss=" + cur_lat_news.news_id).done(function () {
                            });
                        }
                    });
                })
            });
        }

            function refresh_latest_news(){
                $.get("/news/update_latest/").done(function(data){
                    //$(".latest-titles-list").prepend(data.string);

                    data.latest_news.forEach(function(cur_lat_news){
                        if(cur_lat_news.shown == false) {
                            $(".latest-titles-list").prepend(data.string[0]);
                            $.get("/news/ss="+cur_lat_news.news_id).done(function(){});
                        }
                    });
                });
                return true;
            }
            refresh_latest_news();
            setInterval(refresh_latest_news, 1000);

    </script>


    <script>
    // Likes
            function add_like_news(news_id) {
                $.ajax({
                    data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                    type: "POST",
                    url: "/news/add_like/n=" + news_id,
                    success: $.get("/news/check_like/n=" + news_id).done(function (data) {
                        $(".news_likes_amount_"+news_id).text(data.likes);
                        $(".liked").text("Liked");
                        $(".disliked").text("Dislikes:")
                    })
                });
            }
            function reload_likes(){
                var url = location.href.split("/");
                $.get("/news/check_like/n="+url[url.length-2]).done(function(data){
                    $(".news_likes_amount_"+url[url.length-2]).text(data.likes);
                });
                return true;
            }
            reload_likes();
            setInterval(reload_likes, 1000);
    </script>
    <script>
    // Dislikes
        function add_dislike_news(news_id) {
                $.ajax({
                    data: {'csrfmiddlewaretoken': '{{ csrf_token }}'},
                    type: "POST",
                    url: "/news/add_dislike/n=" + news_id,
                    success: $.get("/news/check_dislike/n=" + news_id).done(function (data) {
                        $(".news_dislikes_amount_"+news_id).text(data.dislikes);
                        $(".disliked").text("Disliked");
                        $(".liked").text("Likes:")
                    })
                });
            }
            function reload_dislikes(){
                var url = location.href.split("/");
                $.get("/news/check_dislike/n="+url[url.length-2]).done(function(data){
                    $(".news_dislikes_amount_"+url[url.length-2]).text(data.dislikes);
                });
                return true;
            }
            reload_dislikes();
            setInterval(reload_dislikes, 1000);
    </script>


    <style>
        #id_comments_text{
            height: 3em;
            resize: none;
            margin-left: 1%;
            width: 85%;
        }
        #id_reply_text{
            height: 3em;
            resize: none;
            margin-left: 5%;
        }

    </style>

    <div class="container-fluid" data-news-id="{{ current_news_values.id }}" style="width: 64.5%; border: solid 1px lawngreen; float: left;">

        <div class="tre" style="border: solid 1px red; width: 100%;">

            <h1 class="page-header" style="margin: 0 5%;">
                {{ current_news_values.news_title }}
            </h1>
            <div class="date-and-author" style="margin-left: 5%;">
                <h5>By&nbsp;<a href="/search/?q={{ current_news_values.news_portal_name }}">{{ current_news_values.news_portal_name }}</a>&nbsp;{{ current_news_values.news_post_date.date }}</h5>
            </div>
            <div class="news-cover" style="height: 400px; background: url('/media/{{ current_news_values.news_main_cover }}') no-repeat center;">
            </div>
            <div class="news-post-text" style="margin: 0 15%;">
                {{ current_news_values.news_post_text|safe|linebreaks }}
            </div>
            <div class="nav-bar" style="margin-left: 63%;">
                <ul class="list-inline">
                    <li>
                        <span data-news-id="{{ current_news_values.id }}"
                              class="news_likes"
                              id="add_like_{{ current_news_values.id }}"
                              onclick="add_like_news('{{ current_news_values.id }}');">
                            <div class="liked" style="float: left;">
                                {% if liked == False %}
                                    Likes:
                                {% else %}
                                    <!-- Break like -->
                                    <span
                                        data-news-id="{{ current_news_values.id }}"
                                        class="break_like"
                                        id="break_like_{{ current_news_values.id }}"
                                        onclick="">Liked</span>
                                {% endif %}
                            </div>
                        </span>&nbsp;
                        <span class="news_likes_amount_{{ current_news_values.id }}">
                            {{ like_amount }}
                        </span>
                    </li>&nbsp;|
                    <li>
                        <span
                                data-news-id="{{ current_news_values.id }}"
                                class="news_dislikes"
                                id="add_dislike_{{ current_news_values.id }}"
                                onclick="add_dislike_news('{{ current_news_values.id }}');">
                            <div class="disliked" style="float: left;">
                                {% if disliked == False %}
                                    Dislikes:
                                {% else %}
                                    <!-- Break dislike -->
                                    <span
                                        data-news-id="{{ current_news_values.id }}"
                                        class="break_dislike"
                                        id="break_dislike_{{ current_news_values.id }}"
                                        onclick="">Disliked</span>
                                {% endif %}
                            </div>
                        </span>&nbsp;
                        <span class="news_dislikes_amount_{{ current_news_values.id }}">
                            {{ dislike_amount }}
                        </span>
                    </li>&nbsp;|
                    <li>
                        <div class="sharing">
                            <a onclick="javascript:SharePopUpShow();">
                                SHARE
                            </a>
                        </div>
                    </li>&nbsp;|
                    <li>
                        {% if current_news_values.news_post_date.day < current_day %}
                            {{ current_news_values.news_post_date.date }}
                        {% else %}
                            {{ current_news_values.news_post_date.time }}
                        {% endif %}
                    </li>
                    {% if current_news_values.news_event == True %}
                        <li>
                            {% if current_news_values.news_event_date.day <= current_day %}
                                <!-- Change to "news_event_date" -->
                                Add&nbsp;to&nbsp;calendar
                            {% else %}
                                Event
                            {% endif %}
                        </li>
                    {% endif %}
                </ul>
            </div>

            <!--<button
                    id="comments-load-button"
                    style="margin-left: 45%;"
                    data-category="{{ current_news_values.news_category_id }}"
                    data-news="{{ current_news_values.id }}">
            Comments
            </button>-->

            <div id="comments-here" style="display: block;">


                <div class="comments-block">
                    {% if username %}
                    <!-- COMMENTS -->
                        <form
                                id="comments_form"
                                style="margin-top: 1%; margin-left: 4%;"
                                action="/news/send/cat={{ current_news_values.news_category_id }}&id={{ current_news_values.id }}/"
                                method="post">
                            {% csrf_token %}
                            <div class="user-photo" style="float: left; width: 3em; height: 3em; border-radius: 5px; background-color: orange;">
                                &nbsp;
                            </div>

                            <textarea
                                    id="id_comments_text"
                                    name="comments_text"
                                    maxlength="512"
                                    rows="12"
                                    placeholder="Leave&nbsp;your&nbsp;comment..."
                                    onfocus="document.getElementById('id_comments_text_submit').style.display='block';
                                    this.style.height='5em'"
                                    onblur="this.style.height='3em'; document.getElementById('id_comments_text_submit').style.display='none'"
                                    onkeydown="if(event.keyCode == 13 && !event.shiftKey){
                                        event.preventDefault();
                                        $('#comments_form').submit();
                                    }
                                    else{
                                        if(event.keyCode == 27){
                                            this.onblur();
                                        }
                                    }"
                            ></textarea>
                            <input id="id_comments_text_submit" type="submit" value="Send" style="margin-left: 91.5%; display: none;">
                        </form>
                    {% else %}
                        <div class="announce" style="text-align: center">
                            To&nbsp;leave&nbsp;comments&nbsp;you&nbsp;have&nbsp;to&nbsp;
                            <span onclick="location.href='/auth/login/'"
                                  class="sign-in-to-comments"
                                  style="color: #5bc0de;"
                                  onmouseover="this.style.cursor='pointer';">
                                sign&nbsp;in
                            </span>
                        </div>
                    {% endif %}


                    <div class="comments" style="border: solid 1px lawngreen; width: 87.5%; margin-left: 4%;">
                        {% for current_comment in comments_total %}
                            <div class="current_comment" style="border: solid 1px red;">
                                <div class="current_comment_auhor">
                                    {{ current_comment.comments_author_id|get_username }}
                                </div>
                                <div class="current_comment_text" style="margin-left: 5%;">
                                    {{ current_comment.comments_text|safe|linebreaks }}
                                </div>
                                <div class="current_comment_info" style="margin-left: 60%;">
                                    <span
                                            id="span_show_reply_form"
                                        onclick="$('#id_reply_text').val('{{ current_comment.comments_author_id|get_username }},&nbsp;');
                                                document.getElementById('reply_form_comment_{{ current_comment.id }}').style.display='block';
                                                document.getElementById('reply_form__comment_{{ current_comment.id }}').onfocus();"
                                    >Reply</span>&nbsp;|
                                    Likes:&nbsp;{{ current_comment.comments_likes }}&nbsp;|
                                    Dislikes:&nbsp;{{ current_comment.comments_dislikes }}&nbsp;|
                                    {{ current_comment.comments_post_date.date }}
                                </div>
                                <form id="reply_form_comment_{{ current_comment.id }}"
                                      style="display: none;"
                                      action="/news/reply/nid={{ current_news_values.id }}&cid={{ current_comment.id }}/"
                                      method="post">
                                        {% csrf_token %}
                                        <textarea
                                                autofocus
                                                id="id_reply_text"
                                                cols="83"
                                                rows="10"
                                                name="reply_text"
                                                maxlength="512"
                                                wrap="soft"
                                                placeholder="Leave&nbsp;your&nbsp;reply..."
                                                onfocus="document.getElementById('id_reply_text_submit_{{ current_comment.id }}').style.display='block';
                                                         this.style.height='5em'"
                                                        onblur="document.getElementById('reply_form_comment_{{ current_comment.id }}').style.display='none'"
                                                onkeydown="if(event.keyCode == 13 && !event.shiftKey){
                                                    event.preventDefault();
                                                    $('#reply_form_comment_'+'{{ current_comment.id }}').submit();
                                                }
                                                else{
                                                    if(event.keyCode == 27){
                                                        this.onblur();
                                                    }
                                                }"
                                        ></textarea>
                                        <input id="id_reply_text_submit_{{ current_comment.id }}" type="submit" value="Reply" style="margin-left: 92%;">
                                    </form>
                            </div>

                            <!-- REPLIES -->
                            <div class="replies" style="margin-left: 5%;">
                                {% for current_reply in replies_total %}
                                    {% if current_reply.comment_attached_id == current_comment.id %}
                                        <div class="current_reply" style="margin-top: 1%; border: solid 1px blue;">
                                            <div class="reply_author">
                                                {{ current_reply.reply_author_id|get_username }}
                                            </div>
                                            <div class="reply_text" style="margin-left: 5%;">
                                                {{ current_reply.reply_text|safe|linebreaks }}
                                            </div>
                                            <div class="reply_configs" style="margin-left: 58%;">
                                                <span
                                                onclick="$('id_reply_textarea').val('123');
                                                        document.getElementById('reply_form_{{ current_reply.id }}').style.display='block';"
                                                >Reply</span>&nbsp;|
                                                Likes:&nbsp;{{ current_reply.reply_likes }}&nbsp;|
                                                Dislikes:&nbsp;{{ current_reply.reply_dislikes }}&nbsp;|
                                                {% if current_reply.reply_post_date.day == current_day %}
                                                    {{ current_reply.reply_post_date.time }}
                                                {% else %}
                                                    {{ current_reply.reply_post_date.date }}
                                                {% endif %}
                                                <span
                                                        name="delete-reply"
                                                        onclick="location.href='/news/rd={{ current_reply.id }}/';">
                                                    <a>delete</a></span>
                                            </div>
                                        </div>

                                        <form
                                            id="reply_form_{{ current_reply.id }}"
                                            style="display: none;"
                                            action="/news/reply/nid={{ current_news_values.id }}&cid={{ current_comment.id }}/"
                                            method="post">
                                            {% csrf_token %}
                                            <textarea
                                                    autofocus
                                                    id="id_reply_textarea"
                                                    cols="83"
                                                    rows="10"
                                                    name="reply_text"
                                                    maxlength="512"
                                                    wrap="soft"
                                                    onfocus="document.getElementById('reply_form_second_{{ current_reply.id }}').style.display='block';
                                                         this.style.height='5em'"
                                                onblur="document.getElementById('reply_form_second_{{ current_reply.id }}').style.display='none';
                                                        document.getElementById('reply_form_{{ current_reply.id }}').style.display='none'"
                                                onkeydown="if(event.keyCode == 13 && !event.shiftKey){
                                                    event.preventDefault();
                                                    $('#reply_form_'+'{{ current_reply.id }}').submit();
                                                }
                                                else{
                                                    if(event.keyCode == 27){
                                                        this.onblur();
                                                    }
                                                }"
                                            ></textarea>
                                            <input id="reply_form_second_{{ current_reply.id }}" type="submit" value="Reply" style="margin-left: 92%;">
                                        </form>
                                    {% endif %}

                                {% endfor %}
                            </div>
                            <hr>
                        {% endfor %}
                    </div>
                </div>
            </div>


            <hr style="height: 2px;" color="red" width="100%">
            Other&nbsp;materials&nbsp;of&nbsp;{{ current_news_values.news_category }}
            <div class="other-materials" style="border: solid 1px red; height: 720px;">
                {% for current_other in other_materials %}
                    <div class="current_rss_news_{{ i.id }}"
                             style="width: 32%; height: 25em; margin-left: 1%; margin-top: 1%; border: solid 1px red; float: left;">
                            <div class="title"><a href="/news/{{ current_other.news_category_id }}/{{ current_other.id }}/">{{ current_other.news_title }}</a></div>
                            <div class="portal" style="float: left;">By <a href="/search/?q=">%portal name%</a></div>
                            <div class="published">&nbsp;|&nbsp;{{ current_other.news_post_date.time }}</div>

                            <div class="news-image" style="background-color: red; width: 100%; height: 50%;">

                            </div>

                            <div class="description">{{ current_other.post_text|safe|striptags|truncatewords:"9" }}</div>
                            <div class="navigation" style="float: right;">Share&nbsp;|&nbsp;Like</div>
                        </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <div class="right-side-block" style="border: solid 1px red; margin-left: 65%; margin-right: 5%;">
        <div class="latest-news"
        style="border: 1px solid blue; box-shadow: 2px 2px 2px rgba(0,0,0,5);">
            <div class="latest-header" style="text-align: center;">
                Latest&nbsp;news
            </div>
            <div class="latest-titles">
                    {% for i in latest_news %}
                                <span class="time" style="color: blue;">
                                    {{ i.news_post_date.time }}
                                </span>
                                <span class="title"
                                      onmouseover="this.style.color='blue'; style.cursor='pointer';"
                                      onmouseout="this.style.color='black';"
                                      onclick="location.href='/news/{{ i.news_category_id }}/{{ i.id }}/';">
                                    {{ i.news_title }}
                                </span><br>
                    {% endfor %}
            </div>
        </div>
        <div class="video-and-subs">
            {% include 'twitter.html' %}
        </div>

    </div>


{% endblock %}