{% extends 'index_new.html' %}
<meta charset="UTF-8">
{% load staticfiles %}
{% load my %}
{% load jsonate_tags %}
{% load endless %}
{% block user_news %}

    <script>
        function loadPage() {
            alert("in");
            $.get('/news/new_page/cp=1&np=2/').done(function (data) {
                alert("get ok");
            });
        }
    </script>
    <script>

        String.prototype.format = function(placeholders) {
                var s = this;
                for(var propertyName in placeholders) {
                    var re = new RegExp('{' + propertyName + '}', 'gm');
                    s = s.replace(re, placeholders[propertyName]);
                }
                return s;
            };

        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }


        function updateUserRssPortals() {
                $.get("/news/update_user_rss/").done(function (data) {
                    var table = $(".user-chosen-portals").val("");
                    data.portals.forEach(function(portal){
                        var sstring = "<span onclick='removeUserRssPortal({uuid}, {pid});'>X</span>".format({uuid:portal.cur_user, pid:portal.id});
                        table.val(portal.name+" + "+ sstring +"<br>");
                    })
                });
            return true;
            }

            //updateUserRssPortals();
            //setInterval(updateUserRssPortals, 100);


        function removeUserRssPortal(uuid,pid, id){
            $("#ajax-preloader").show();
            $("html").css("overflowY", "hidden");
            var $link = "/news/update_user_rss_news/";
            var csrftoken = getCookie('csrftoken');
            $.ajax({
                url: "/news/rrp&uid="+uuid+"&pid="+pid+"/",
                type: "POST",
                data: {
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                contentType: "application/x-www-form-urlencoded;charset=utf-8",
                success: function(result){
                    updateUserRssPortals();
                    $("#curp-"+id).slideToggle();
                    $("body").html("<img src='{% static 'static/img/ajax-loader.gif' %}' alt='Loading...' />").load("/news/usernews/page=1/");
                    $("#ajax-preloader").hide();
                    $("html").css("overflowY", "auto");
                }
            })
        }



    </script>


    <style>
        .pagination ul{
            list-style-type: none;
        }
        .pagination li{
            margin-left: 1%;
            margin-right: 1%;
            float: left;
        }
        .current_rss_news{
            width: 32%;
            height: 25em;
            margin-left: 1%;
            margin-top: 1%;
            border-radius: 5px;
            box-shadow: 0 0 5px black;
            float: left;
        }
        .current_rss_news:hover{
            box-shadow: 0 0 5px blue;
        }
    </style>

    <div class="container-fluid">
        <div id="rss-news" style="border: solid 1px red; width: 70%; margin-left: 1%; float: left;">


        {% if user_rss|length >= 1 %}
            <div id="rss-title" style="text-align: center;">
                All news which are your interested in
            </div>

            <div id="rss-news-total-list">
                {% lazy_paginate 12 test %}
                {% for i in test %}
                    <div class="current_rss_news"
                         id="rss_id_{{ i.id }}"
                         data-current-rss-news-id="{{ i.id }}"
                         onclick="RssPreviewPopUpShow('{{ i|jsonate }}')"
                         style="">
                        <div class="title">{{ i.title }}</div>
                        <div class="portal" style="float: left;">By <a href="/search/?q={{ i.portal_name_id }}">{{ i.portal_name_id|get_rss_portal_name }}</a></div>
                        <div class="published">&nbsp;|&nbsp;{{ i.date_posted.time }}</div>
                        <div class="news-image" style="background: url({{ i.id|get_rss_news_cover }}) no-repeat center; background-size: cover;  width: 100%; height: 50%;"></div>
                        <div class="description">{{ i.post_text|safe|striptags|truncatewords:"9" }}</div>
                        <div class="navigation" style="float: right;">Share&nbsp;|&nbsp;Like</div>
                    </div>
                {% endfor %}
                {% show_more %}
            </div>
            <hr width="100%">


            <!-- PAGINATION -->
            <div class="pagination" style="margin-top: 5%; width: 200px; border: solid 1px red; ">
                    <ul>
                        {% if rss_news.has_previous %}
                            <li class="arrow"><a href="/news/usernews/page={{ rss_news.previous_page_number }}/">&laquo;</a></li>
                        {% else %}
                            <li class="arrow unavailable"><a href="">&laquo;</a></li>
                        {% endif %}
                        {% for page in rss_news.paginator.page_range %}
                            {% if page == rss_news.number %}
                                <li class="current"><a href="/news/usernews/page={{ page }}/">{{ page }}</a></li>
                            {% else %}
                                <li><a href="/news/usernews/page={{ page }}/">{{ page }}</a></li>
                            {% endif %}
                        {% endfor %}
                        {% if rss_news.has_next %}
                            <li class="arrow"><a href="/news/usernews/page={{ rss_news.next_page_number }}/">&raquo;</a></li>
                        {% else %}
                            <li class="arrow unavailable"><a href="">&raquo;</a></li>
                        {% endif %}
                    </ul>
                </div>



            <div class="load_button" >
                <button id="button_load_more"
                        onclick="loadPage();"
                        data-current-page="1"
                        data-next-page="2">Load&nbsp;more</button>
            </div>
        {% else %}
            <div class="user_rss_missing" style="text-align: center;">
                At this time you have no one portals to syndicate for you.
                <br>
                Would you like to choose any one? <a href="/profile/#settings-form">Click</a> to set your own preferences.
            </div>
            <div class="most-popular">
                <div class="title">The most popular portals.</div>
                <div class="most-popular-portals">
                    {% for current_popular_rss in popular_rss %}
                        <div class="sect-rss" style="float: left; width: 31%; margin-top: 1%; margin-left: 2%;">
                            <div class="current_rss_popular_portal"
                                 style="box-shadow: 0 0 10px rgba(0,0,0,0.5); height: 100px; width: 100%;"
                                 onmouseover="style.border='solid 0.2px blue';"
                                 onmouseout="style.border='';"
                                 onclick="location.href='/news/{{ current_popular_rss.news_category_id }}/{{ current_interest.id }}/';">
                                <div class="">
                                    {{ current_popular_rss.portal }}
                                    <div class="add-current" style="position: static; margin-top: 18%; margin-left: 90%;">
                                        <img src="{% static 'static/img/plus.png' %}" width="20px" />
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}



        </div>
        <div class="right-side" style="width: 28%; border: solid 1px orange; float: right;">
            <div class="choosen-portals" style="border: solid 1px red;">

                {% if user_rss|length < 1 %}
                    Recommended&nbsp;portals
                    <div class="recommendations" style="border: solid 1px red; height: 20em; overflow-y: auto;">
                        {% for cur_rss_portal in popular_rss_right %}
                            <span class="">{{ cur_rss_portal.portal }}</span><br>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="user-rss-portals" style="text-align: center">
                        Your&nbsp;current&nbsp;portals
                    </div>
                    <div class="user-chosen-portals" style="border: solid 1px red; height: 20em; overflow-y: auto;">
                            {% for i in user_rss %}
                                <div id="curp-{{ i.id }}">
                                    <span class="user-portals">{{ i.portal_id|get_rss_portal_name }}</span>
                                    <a href="">+</a>
                                    <!--<a href="/news/rrp&uid={{ username.profile.uuid }}&pid={{ i.portal_id }}/">X</a>-->
                                    <span onclick="removeUserRssPortal('{{ username.profile.uuid }}', '{{ i.portal_id }}', '{{ i.id }}');">X</span>
                                    <hr width="100%">
                                </div>
                            {% endfor %}
                    </div>
                {% endif %}
            </div>

            <div class="subscribe">
                <div class="subscribe-speech">
                    Would you like to get notification about latest news and reviews?
                    <br>
                    To take it just write your email and we will send you a link to continue.
                </div>
                <form>
                    <input type="email" name="sub-email" autocomplete="off" id="sub-email" placeholder="Enter your email">
                    <input type="submit" value="Accept">
                </form>
            </div>

        </div>
    </div>

    {% include 'footer.html' %}

{% endblock %}